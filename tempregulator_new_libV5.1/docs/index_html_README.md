# Обзор `index.html`                                                             <!-- Modified: документация по веб-интерфейсу -->

Веб-интерфейс загружается из `data/index.html` и взаимодействует с прошивкой
через WebSocket `ws://192.168.4.1:1337/`. Страница построена вокруг набора
вкладок, каждая из которых соответствует температурному профилю.

## Ключевые участники

* **`wsConnect(url)`** — устанавливает соединение с WebSocket и настраивает
  обработчики событий (`onOpen`, `onClose`, `onMessage`, `onError`). При
  успешном подключении сразу отправляет команду `InitProfil`, чтобы получить
  список профилей и текущие настройки устройства.
* **`LoadProfil(nProfil, sProfileName, tableDataObjectsProfil)`** — создаёт
  элементы управления для конкретного профиля. Вкладка содержит поле ввода
  имени, таблицу параметров и кнопки «Сохранить»/«Удалить». Для тестового
  профиля (`TestProfileId = 1`) дополнительно выводится подсказка и отключаются
  проверки входных данных.
* **`openTestProfileTab()`** — вспомогательная функция для быстрого переключения
  на тестовый профиль. Она вызывает `LoadProfil` с именем «Тестовый профиль» и
  активирует соответствующую вкладку без запуска валидаций.
* **`SaveProfil(nProfil)`** — собирает данные из DOM, формирует JSON вида
  `{ "eventMessage": "SaveProfil", "UserTmpProf_x": {...} }` и отправляет
  их через WebSocket. После сохранения имя вкладки обновляется, а данные
  кэшируются в `DataGlobalProf`.
* **`DeleteProfil(nProfil)`** — обнуляет данные профиля и отправляет команду
  `DelProfil`. Таблица заполняется нулями, а флаг видимости в веб-интерфейсе
  переключается в `false`.
* **`ValidityInputsNameProfile` / `ValidityTableData`** — проверяют уникальность
  имени и корректность значений таблицы. Для тестового профиля проверки
  отключаются, что позволяет быстро подставлять любые значения без ограничений.
* **`startTimerprofil`/`stopTimerprofil` и `startTimerstupen`/`stopTimerstupen`**
  — запускают и останавливают таймеры отображения длительности профиля и
  текущей ступени. Значения приходят с прошивки в поле `timestartprofil` или
  `timestartstupen`.

## Жизненный цикл страницы

1. При загрузке вызывается `init()`, которая подключает WebSocket.
2. После получения события `InitProfil` страница:
   * Заполняет глобальный словарь `DataSettings` (калибровка, активный профиль,
     скорость нагрева, комнатная температура).
   * Создаёт вкладки для всех профилей, у которых `isAvailableForWeb == true`.
   * Если активный профиль не выбран, вкладка «Главная» остаётся активной, а
     кнопка «+ Добавить профиль» доступна.
3. Пользователь может редактировать таблицу профиля. Все ячейки работают в
   режиме `contentEditable`, а ввод фильтруется регулярными выражениями.
4. После отправки `SaveProfil` прошивка отвечает обновлённым состоянием, а
   вкладка обновляется локально.
5. В фоне с интервалом ~1 с приходит телеметрия (`actualtemp`, `seltemp`,
   `stateprofil`, флаги `profisAlarm`/`regisAlarm`, таймеры). Изменившиеся
   значения сразу отображаются на странице.

## Тестовый профиль

Профиль с идентификатором `TestProfileId = 1` создаётся в прошивке с именем
«Тестовый профиль». Для него:

* Валидация имени и значений таблицы отключена (`ValidityInputsNameProfile`
  и `ValidityTableData` возвращают `true`).
* При создании вкладки вызывается `createTestProfileHints`, которая выводит
  подсказку и напоминает, что профиль предназначен для ручного ввода данных.
* Сохранение/удаление отправляет те же команды, что и для обычных профилей, но
  благодаря отсутствию проверок можно экспериментировать с любыми данными.

## Структура JSON-сообщений

* **Инициализация:**
  ```json
  {
    "eventMessage": "InitProfil",
    "UserTmpProf_1": {
      "sNVSnamespace": "UserTmpProf_1",
      "sNameProfile": "Тестовый профиль",
      "isAvailableForWeb": true,
      "data": [ { "1_1": 0, "1_2": 0, "1_3": 0 }, ... ]
    },
    "Settings": {
      "activProf": 0,
      "isKalibrate": false,
      "speedHot": 0,
      "tRoom": 0
    }
  }
  ```
* **Сохранение:** сообщение содержит объект `UserTmpProf_x` с таблицей данных и
  флагом `isAvailableForWeb`.
* **Удаление:** структура аналогична сохранению, но данные обнуляются, а флаг
  видимости принудительно сбрасывается.

## Подсказки по отладке

* Для анализа входящих сообщений используйте вывод консоли браузера — все
  события логируются в `onMessage`.
* Функция `EmulEspMsg()` (оставлена в комментариях) показывает пример
  формирования сообщения «InitProfil» для эмуляции прошивки.
* Состояние профиля (`stateprofil`), активный профиль (`activprof`) и
  температура (`actualtemp`) обновляются дифференциально: страница реагирует
  только на изменения, что упрощает поиск ошибок в телеметрии.

