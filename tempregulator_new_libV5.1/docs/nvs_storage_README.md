# Документация по работе с NVS                                             <!-- Modified: описание механизма Preferences -->

## Общий экземпляр `Preferences`

* Файл [`GlobalPreferences.h`](../GlobalPreferences.h) объявляет глобальный
  объект `Preferences preferences`. Этот экземпляр используется во всех модулях
  прошивки, чтобы гарантировать единый доступ к NVS.
* Одновременно с объектом создаётся рекурсивный мьютекс `preferencesMutex` и
  RAII-обёртка `PreferencesLock`. Любая функция, которая работает с NVS,
  захватывает `PreferencesLock` перед вызовом `preferences.begin(...)`, тем
  самым защищая операции от одновременного доступа из разных задач (например,
  основного цикла и веб-сервера).
* После получения блокировки функция вызывает `preferences.begin(namespace,
  readOnly)` и обязательно завершает работу с пространством через
  `preferences.end()` перед выходом. Это исключает ситуации с незакрытыми
  дескрипторами и гарантирует, что последующие операции смогут открыть
  пространство.

## Температурные профили

* Модуль [`TemperatureProfile.cpp`](../TemperatureProfile.cpp) читает и пишет
  профили с использованием общего `preferences`. Каждому профилю соответствует
  пространство `UserTmpProf_N` (от 1 до 10).
* Метод `loadFromNVS()` загружает имя, флаги видимости, коэффициенты PID и
  таблицу шагов, проходя по ключам `rowX_rStartTemp`, `rowX_rEndTemp` и
  `rowX_rTime`.
* Метод `saveToNVS()` перезаписывает все ключи и затем повторно вызывает
  `loadFromNVS()`, чтобы актуализировать состояние объекта в оперативной памяти.
* `clearInNVS()` использует `saveToNVS()` с пустыми значениями, тем самым
  сбрасывая профиль и выключая его отображение в UI и вебе.

## Настройки эмуляции/веб-интерфейса

* Веб-интерфейс хранит настройки (`activProf`, `isKalibrate`, `speedHot`,
  `tRoom`) в пространстве `Settings`. Запись выполняется через функцию
  `saveWebSettings()` внутри [`WebInterface.cpp`](../WebInterface.cpp).
* При инициализации фронта вызывается `EmulSettingsToJSON()`, которая читает
  значения из NVS и формирует JSON для вкладки настроек.

## Последовательность работы

1. На старте вызывается `ensureDefaultTemperatureProfiles()`, которое создаёт
   заготовки в `UserTmpProf_1..10`, если они отсутствуют.
2. `TempRegulator::loadTemperatureProfiles()` и `WebInterface::processInitDataToWeb()`
   читают данные через общий `preferences` и отправляют их в UI и браузер.
3. Когда пользователь сохраняет профиль в вебе, `ParseProfileDataFromWeb()`
   разбирает JSON и передаёт данные в `SaveProfileDataToNVS()`.
4. После записи профиль заново загружается из NVS, чтобы не возникало расхождений
   между памятью и содержимым хранилища.

## Отладка

* Все ключевые операции (`SaveProfileDataToNVS`, `ClearProfileDataFromNVS`,
  ошибки открытия пространства) логируются через `Serial`, что упрощает сбор
  диагностических сообщений.
* Для тестирования можно удалить пространство NVS через инструменты ESP32 или
  вызвать `ClearProfileDataFromNVS()` из веба — профиль будет сброшен к нулевым
  значениям.

